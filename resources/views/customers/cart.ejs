<section class="cart py-16">
    <%if(session.cart && session.cart.totalQty !=0){%>
        <div class="order container mx-auto lg:w-1/2">
            <div class="flex item-cnter border-b border-gray-300 pb-4">
                <img src="/img/cart-black.png" alt="cart">
                <h1 class="font-bold ml-4 text-2xl">Order Summary</h1>
            </div>
            <div class="pizza-list">
                <% for(let food of Object.values(session.cart.items)){%>
                    <div class="flex items-center my-8">
                        <img class="w-12 md:w-24" src="/img/<%= food.items.image%>" alt="food">
                        <div class="flex-1 ml-4">
                            <h1>
                                <%= food.items.name%>
                            </h1>
                            <span>
                                <%= food.items.size%>
                            </span>
                        </div>
                        <span class="flex-1">
                            <%= food.qty%> Pcs
                        </span>
                        <span class="font-bold text-lg">‚Çπ<%= food.items.price *food.qty %></span>
                        <img data-items="<%= JSON.stringify(food)%>" class="ml-4 cursor-pointer deleteItems"
                            src="/img/delete.png" alt="delete">
                    </div>
                    <% }%>
            </div>
            <hr>
            <!--Add Address and Edit Address + payment Section-->
            <div class="py-4">
                <div class="p-2 sm:p-6">
                    <div class="flex flex-row justify-between items-center mb-4 gap-2">
                        <h2 class="text-base sm:text-lg font-semibold">Address</h2>
                        <a href="/customers/add-address">
                            <button
                                class="border border-green-500 text-green-600 px-3 py-1 rounded hover:bg-green-50 transition font-semibold flex items-center text-sm">
                                <span class="text-xl mr-1">+</span> Add New
                            </button>
                        </a>
                    </div>
                    <hr class="mb-4">
                    <div class="flex flex-wrap gap-4 justify-start overflow-x-auto" style="row-gap: 1rem;">
                        <!-- Address Card -->
                        <% if(address.length==0) { %>
                            <div class="flex items-center justify-center w-full">
                                <div class="p-4 flex flex-col justify-center max-w-xs mx-auto sm:mx-0 relative items-center"
                                    style="max-width: 15rem; min-width: 220px; flex-basis: 220px;">
                                    <img src="/img/dataNotFound.svg" alt="Address Not Found"
                                        class="w-24 h-24 mx-auto mb-4">
                                    <p class="text-gray-500 text-center">No address found. Please add a new address.</p>
                                    <a href="/customers/add-address">
                                        <button
                                            class="border border-green-500 text-green-600 px-3 py-1 rounded hover:bg-green-600 hover:text-white transition font-semibold flex items-center text-sm mt-4"
                                            style="width: 8rem;">
                                            <span class="text-xl mr-1">+ </span> Add Address
                                        </button>
                                    </a>
                                </div>
                            </div>
                            <% } else { address?.addressInfo?.forEach((addr, index)=> {
                                const isChecked = index === 0 ? 'checked' : '';
                                const radioId = `address${index}`;
                                %>
                                <div class="border rounded p-4 flex-1 min-w-[220px] max-w-xs bg-white mx-auto sm:mx-0 relative"
                                    style="max-width: 15rem; min-width: 220px; flex-basis: 220px;">
                                    <input type="radio" name="selectedAddress" id="<%= radioId %>"
                                        class="absolute left-2 top-2" value="<%= JSON.stringify(addr).replace(/'/g, 
                                        " &#39;") %>" <%=isChecked %> style="top:22px;">
                                        <label for="<%= radioId %>" class="block pl-6 cursor-pointer">
                                            <div class="flex justify-between mb-2">
                                                <span class="font-semibold">Address <%= index+1 %></span>
                                                <span class="font-semibold text-orange-600">
                                                    <%= addr.addressType.toUpperCase() %>
                                                </span>
                                            </div>
                                            <hr>
                                            <div class="text-xs leading-6 py-2"
                                                style="font-weight: 200; line-height: 1rem;">
                                                <div><span class="font-semibold">Phone Number :</span>
                                                    <%= addr.phone %>
                                                </div>
                                                <div><span class="font-semibold">Address Line1 :</span>
                                                    <%= addr.addressLine1 %>
                                                </div>
                                                <div><span class="font-semibold">Address Line2 :</span>
                                                    <%= addr.addressLine2 %>
                                                </div>
                                                <div><span class="font-semibold">City :</span>
                                                    <%= addr.city %>
                                                </div>
                                                <div><span class="font-semibold">State :</span>
                                                    <%= addr.state %>
                                                </div>
                                                <div><span class="font-semibold">Landmark :</span>
                                                    <%= addr.landmark %>
                                                </div>
                                                <div><span class="font-semibold">Pin :</span>
                                                    <%= addr.postalCode %>
                                                </div>
                                            </div>
                                            <div class="mt-2 text-right">
                                                <a href="/customers/edit-address/<%= addr._id %>"
                                                    class="text-orange-600 font-semibold hover:underline text-sm">Edit</a>
                                            </div>
                                        </label>
                                </div>
                                <% })}; %>
                    </div>
                </div>
            </div>
            <!--End Address Section-->
            <hr>
            <div class="py-2">
                <div class="p-2 sm:p-6">
                    <div class="flex flex-row justify-between items-center mb-4 gap-2">
                        <h2 class="text-base sm:text-lg font-semibold pb-2">Payment</h2>
                        <span class="material-symbols-outlined">
                            receipt_long
                        </span>
                    </div>
                    <hr>
                    <div class="bg-gradient-to-br from-orange-50 to-white rounded-xl p-6 mt-4">
                        <h3 class="text-lg font-bold mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined">payments</span>
                            Choose Payment Method
                        </h3>
                        <div class="flex flex-col sm:flex-row gap-4 mb-8">
                            <label
                                class="flex items-center cursor-pointer bg-white border border-orange-200 rounded-lg px-4 py-3 transition hover:shadow-md">
                                <input type="radio" name="paymentMethod" value="cod" class="accent-orange-500 mr-3"
                                    checked>
                                <span class="text-base font-semibold text-gray-800">Cash on Delivery (COD)</span>
                            </label>
                            <label
                                class="flex items-center cursor-pointer bg-white border border-orange-200 rounded-lg px-4 py-3 gap-2 transition hover:shadow-md"
                                aria-disabled="true" title="Online payments are temporarily disabled.">
                                <input type="radio" name="paymentMethod" value="online" class="accent-orange-500 mr-3">
                                <span class="text-base font-semibold text-gray-800 flex items-center gap-2">
                                    Online Payment
                                    <span
                                        class="bg-green-400 text-white text-xs font-bold px-2 py-0.5 rounded-full border border-gray-200 shadow-sm ml-2 text-center"
                                        style="width: 80px;">
                                        Œ≤ Test
                                    </span>
                                </span>
                            </label>
                        </div>
                        <div class="border-t pt-6">
                            <h4 class="text-base font-bold mb-4 text-gray-700">Bill Summary</h4>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-600">Total Amount</span>
                                <span class="font-semibold text-gray-800">‚Çπ<%= session.cart.totalPrice %></span>
                            </div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-600">Delivery Fee</span>
                                <span class="font-semibold text-gray-800">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold mt-4">
                                <span class="text-orange-600">Grand Total</span>
                                <span class="text-orange-600">‚Çπ<%= session.cart.totalPrice %></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--End-->
            <div class="text-right py-4">
                <div>
                    <form action="/orders" method="POST">
                        <span class="block text-red-600 text-sm font-bold" id="error_message">
                            <%= messages.error%>
                        </span>
                        <input type="tel" placeholder="Phone Number"
                            class="border border-gray-400 p-2 w-1/2 mb-4 rounded-full pl-6" name="phone" minlength="10"
                            id="phone_input" hidden>
                        <input type="text" placeholder="Address"
                            class="border border-gray-400 p-2 w-1/2 rounded-full pl-6" name="address" id="address_input"
                            hidden>
                        <div>
                            <button class="btn-primary rounded-full px-6 py-3 text-white font-bold mt-6" type="submit">
                                Order Now</button>
                        </div>
                    </form>
                </div>
                <!--<a href="/login" class="btn-primary rounded-full px-6 py-3 text-white font-bold mt-6 inline-block">Login</a>-->
            </div>
        </div>
        <%}else{%>

            <div class="empty-cart">
                <div class="container mx-auto text-center">
                    <h1 class="text-3xl font-bold mb-2">Cart Empty üòï</h1>
                    <p class="text-gray-500 text-lg mb-12">You probably haven't ordered Anythings yet. <br> To order
                        Food go to
                        the main page.</p>
                    <img class="w-2/5 mx-auto" src="/img/empty-cart.png" alt="empty-cart">
                    <button class="btn-primary rounded-full py-3 px-5 font-bold mt-6 text-white"><a href="/">Go
                            Back</a></button>
                </div>
            </div>
            <%}%>

                <!--Loader-->
                <div id="payment-loader"
                    style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.8); z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column; display:none;">
                    <div class="loader"
                        style="border: 8px solid #f3f3f3; border-top: 8px solid #ff9800; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;">
                    </div>
                    <p class="mt-4 text-lg font-semibold text-orange-600">Processing your order, please wait...</p>
                </div>

</section>


<script>

    const updatePaymentType = async () => {
        const response = await fetch('/session/add/payment-type', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
        });
        return response;
    }

    const verifyPayment = async (orderId) => {
        const errorMessage = document.getElementById("error_message");
        const orderForm = document.querySelector("form[action='/orders']");

        const response = await fetch('/api/v1/tools/payment/customers/cashfree/verify', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId })
        });
        const data = await response.json();

        switch (data?.orderStatus) {
            case "PAID":
                const response = await updatePaymentType();
                const data = await response.json();
                if (data.status) {
                    localStorage.setItem('orderId', orderId);
                    orderForm.submit();
                } else {
                    errorMessage.textContent = "Failed to update payment type in session. Please contact support.";
                }
                break;

            case "ACTIVE":
                errorMessage.textContent = "Payment not completed. You dropped the payment.";
                break;

            case "EXPIRED":
                errorMessage.textContent = "Payment expired. Please try again.";
                break;

            case "TERMINATED":
                errorMessage.textContent = "Payment session terminated. Please initiate a new payment.";
                break;

            case "TERMINATION_REQUESTED":
                errorMessage.textContent = "Payment termination in process. Please wait or try again later.";
                break;

            default:
                errorMessage.textContent = "‚ùì Unknown payment status. Please contact support.";
                break;
        }

    }

    document.addEventListener("DOMContentLoaded", function () {
        const orderForm = document.querySelector("form[action='/orders']");
        const paymentLoader = document.getElementById("payment-loader");
        const errorMessage = document.getElementById("error_message");

        orderForm.addEventListener("submit", async function (e) {
            const paymentMethod = document.querySelector("input[name='paymentMethod']:checked").value;

            if (paymentMethod === "online") {
                e.preventDefault(); // stop normal form submit

                // Show loader
                paymentLoader.style.display = "flex";

                try {
                    // Get selected address radio button value
                    const selectedAddressRadio = document.querySelector("input[name='selectedAddress']:checked");
                    if (!selectedAddressRadio) {
                        errorMessage.textContent = "Please select a delivery address before proceeding with payment.";
                        paymentLoader.style.display = "none";
                        return;
                    }

                    // Parse address JSON
                    const selectedAddress = JSON.parse(selectedAddressRadio.value);

                    // Call backend to initiate payment
                    const response = await fetch("/api/v1/tools/payment/customers/cashfree/initiate", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            amount: "<%= session?.cart?.totalPrice %>",
                            customerName: "<%= session?.user?.name %>",
                            customerEmail: "<%= session?.user?.email %>",
                            customerPhone: selectedAddress.phone,
                            userId: "<%= session?.user?.userId %>"
                        })
                    });

                    const result = await response.json();
                    if (!result.status) throw new Error(result.message);

                    const cashfree = Cashfree({ mode: "sandbox" }); //production
                    cashfree.checkout({
                        paymentSessionId: result.data.payment_session_id,
                        redirectTarget: "_modal"
                    }).then(() => {
                        paymentLoader.style.display = "none";
                        verifyPayment(result?.data?.order_id);
                    }).catch((err) => {
                        paymentLoader.style.display = "none";
                        errorMessage.textContent = "Payment failed: " + err.message;
                        throw new Error("Payment failed: " + err.message);
                    });

                } catch (err) {
                    console.error("Payment error:", err);
                    alert("Payment failed: " + err.message);
                    paymentLoader.style.display = "none";
                }
            }
        });
    });

</script>